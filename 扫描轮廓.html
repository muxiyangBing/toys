<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç²’å­è½®å»“æ‰«æå·¥å…· V5.8</title>
    <script src="https://docs.opencv.org/4.5.5/opencv.js" type="text/javascript"></script>
    <style>
        :root { --primary: #4a90e2; --ai: #8e44ad; --bg: #f4f7f9; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; overflow-x: hidden; }
        
        .app-container { display: grid; grid-template-columns: 280px 1fr; gap: 15px; max-width: 1600px; margin: 0 auto; }
        
        /* æ§åˆ¶é¢æ¿ */
        .sidebar { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; }
        .upload-btn { border: 2px dashed #dcdde1; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 13px; margin-bottom: 15px; background: #fafafa; }
        
        .ai-status { 
            background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 12px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(108,92,231,0.2);
        }

        .ctrl-group { margin-bottom: 12px; }
        .ctrl-head { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; color: #666; margin-bottom: 4px; }
        .num-val { width: 50px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px; color: var(--primary); }
        .slider { width: 100%; accent-color: var(--primary); margin-top: 5px; cursor: pointer; }

        /* é¢„è§ˆåŒºåŸŸï¼šæ¨ªå‘å¹¶æ’ */
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .preview-card { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card-label { padding: 8px 12px; background: #fafafa; border-bottom: 1px solid #eee; font-size: 11px; font-weight: bold; color: #888; display: flex; justify-content: space-between; }
        
        /* è§†å£é”å®šé«˜åº¦ï¼šè§£å†³"å·¨å¤§"é—®é¢˜ */
        .viewport { height: 380px; display: flex; justify-content: center; align-items: center; padding: 10px; box-sizing: border-box; }
        .bg-grid { background-image: radial-gradient(#dcdde1 1px, transparent 0); background-size: 12px 12px; background-color: #f9f9f9; }
        .bg-dark { background: #1a1a1a; }

        canvas { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; }

        button { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 8px; font-size: 13px; transition: 0.2s; }
        #exportBtn { background: var(--primary); color: white; }
        #exportBtn:disabled { background: #eee; color: #aaa; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="app-container">
    <aside class="sidebar">
        <div class="upload-btn" onclick="document.getElementById('fileIn').click()">
            <span style="font-size: 20px;">ğŸ–¼ï¸</span><br>ä¸Šä¼ ç´ æå›¾ç‰‡
            <input type="file" id="fileIn" accept="image/*" style="display:none;">
        </div>

        <div class="ai-status">
            <span style="font-size: 12px; font-weight: bold;">ğŸ¤– æ™ºèƒ½ä¸»ä½“è¯†åˆ«</span>
            <input type="checkbox" id="aiOn" style="width:18px; height:18px; cursor:pointer;">
        </div>

        <div class="ctrl-group">
            <div class="ctrl-head"><span>çµæ•åº¦ (Low)</span> <input type="number" id="n1" class="num-val" value="50"></div>
            <input type="range" id="r1" class="slider" min="0" max="255" value="50">
        </div>

        <div class="ctrl-group">
            <div class="ctrl-head"><span>æ¸…æ™°åº¦ (High)</span> <input type="number" id="n2" class="num-val" value="150"></div>
            <input type="range" id="r2" class="slider" min="0" max="255" value="150">
        </div>

        <div class="ctrl-group">
            <div class="ctrl-head"><span>é‡‡æ ·æ­¥é•¿</span> <input type="number" id="step" class="num-val" value="1" min="1"></div>
        </div>

        <button id="exportBtn" disabled>ğŸš€ å¯¼å‡ºç²’å­åæ ‡ç‚¹</button>
        <button onclick="location.reload()" style="background:#f1f2f6; color:#666;">ğŸ”„ é‡ç½®ç”»å¸ƒ</button>
        
        <div style="margin-top: 15px; font-size: 11px; color: #999; line-height: 1.5;">
            <strong>æç¤ºï¼š</strong><br>
            â€¢ å¼€å¯æ™ºèƒ½è¯†åˆ«åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿‡æ»¤å¤§ç†çŸ³çº¹è·¯ç­‰ç¢å°èƒŒæ™¯å¹²æ‰°ã€‚<br>
            â€¢ é’ˆå¯¹å¤æ‚JPGï¼Œå»ºè®®å°†çµæ•åº¦è°ƒè‡³ 80 å·¦å³ã€‚
        </div>
    </aside>

    <main class="preview-grid">
        <div class="preview-card">
            <div class="card-label"><span>â‘  åŸå§‹ç´ æè®°å½•</span><span id="meta">---</span></div>
            <div class="viewport bg-grid"><canvas id="canvasIn"></canvas></div>
        </div>
        <div class="preview-card">
            <div class="card-label"><span>â‘¡ è½®å»“ç»“æœé¢„è§ˆ</span><span id="pts" style="color:var(--primary)">æ•æ‰ç‚¹: 0</span></div>
            <div class="viewport bg-dark"><canvas id="canvasOut"></canvas></div>
        </div>
    </main>
</div>

<script>
    let coords = [], hasImg = false;
    const exportBtn = document.getElementById('exportBtn');

    // åŒå‘ç»‘å®šè¾“å…¥
    function bind(rId, nId) {
        const r = document.getElementById(rId), n = document.getElementById(nId);
        r.oninput = () => { n.value = r.value; mainProcess(); };
        n.onchange = () => { r.value = n.value; mainProcess(); };
    }
    bind('r1', 'n1'); bind('r2', 'n2');
    document.getElementById('step').oninput = mainProcess;
    document.getElementById('aiOn').onchange = mainProcess;

    // æ ¸å¿ƒå¤„ç†å‡½æ•°
    function mainProcess() {
        if (!hasImg || !cv.Mat) return;

        let src = cv.imread('canvasIn');
        let gray = new cv.Mat(), edges = new cv.Mat();
        let dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC4);

        // 1. é¢„å¤„ç†ï¼šç°åº¦ + è½»å¾®é«˜æ–¯æ¨¡ç³Šï¼ˆæ»¤é™¤çº¹ç†å™ªå£°ï¼‰
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        cv.GaussianBlur(gray, gray, new cv.Size(3, 3), 0, 0, cv.BORDER_DEFAULT);

        // 2. è¾¹ç¼˜æ£€æµ‹
        let low = parseInt(document.getElementById('n1').value);
        let high = parseInt(document.getElementById('n2').value);
        cv.Canny(gray, edges, low, high, 3, false);

        const aiActive = document.getElementById('aiOn').checked;
        if (aiActive) {
            let M = cv.Mat.ones(3, 3, cv.CV_8U);
            cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, M); // é—­è¿ç®—è¿æ¥æ–­ç‚¹
            M.delete();
        }

        let contours = new cv.MatVector(), hierarchy = new cv.Mat();
        try {
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            coords = [];
            let s = parseInt(document.getElementById('step').value) || 1;
            
            // 3. æ™ºèƒ½ä¸»ä½“è¯†åˆ«ï¼šé¢ç§¯ç­›é€‰é€»è¾‘
            let validIndices = [];
            if (aiActive) {
                let areaList = [];
                for (let i = 0; i < contours.size(); ++i) {
                    areaList.push({ index: i, area: cv.contourArea(contours.get(i)) });
                }
                // æ’åºå¹¶åªå–é¢ç§¯æœ€å¤§çš„å‰ 10 ä¸ªè½®å»“ï¼Œå¿½ç•¥èƒŒæ™¯çº¹ç†ç¢ç‰‡
                areaList.sort((a, b) => b.area - a.area);
                validIndices = areaList.slice(0, 10).map(x => x.index);
            } else {
                // åŸºç¡€æ¨¡å¼ä¿ç•™æ‰€æœ‰è½®å»“
                for (let i = 0; i < contours.size(); ++i) validIndices.push(i);
            }

            // 4. ç»˜åˆ¶ä¸åæ ‡æå–
            let color = aiActive ? new cv.Scalar(0, 242, 254, 255) : new cv.Scalar(255, 60, 60, 255);
            validIndices.forEach(i => {
                let cnt = contours.get(i);
                cv.drawContours(dst, contours, i, color, 1.2);
                for (let j = 0; j < cnt.data32S.length; j += 2 * s) {
                    coords.push(`${cnt.data32S[j]},${cnt.data32S[j+1]}`);
                }
            });

            cv.imshow('canvasOut', dst);
            document.getElementById('pts').innerText = `æ•æ‰ç‚¹: ${coords.length}`;
            exportBtn.disabled = coords.length === 0;

        } catch (err) { console.error("å¤„ç†å‡ºé”™:", err); }
        finally { src.delete(); gray.delete(); edges.delete(); dst.delete(); contours.delete(); hierarchy.delete(); }
    }

    // ä¸Šä¼ é€»è¾‘
    document.getElementById('fileIn').onchange = (e) => {
        let file = e.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = (ev) => {
            let img = new Image();
            img.onload = () => {
                let can = document.getElementById('canvasIn');
                can.width = img.width; can.height = img.height;
                can.getContext('2d').drawImage(img, 0, 0);
                document.getElementById('meta').innerText = `${img.width}x${img.height} PX`;
                hasImg = true;
                mainProcess();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    // å¯¼å‡ºé€»è¾‘
    document.getElementById('exportBtn').onclick = () => {
        const blob = new Blob([coords.join('\n')], {type: 'text/plain'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'particle_coords.txt';
        link.click();
    };
</script>
</body>
</html>